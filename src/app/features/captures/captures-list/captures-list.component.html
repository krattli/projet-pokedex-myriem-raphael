<div class="page-container">
  <div class="page-content">
    <app-pokedex-tabs activeTab="captures" />

    @if (!authService.isLoggedIn()) {
      <div class="auth-required">
        <i class="fa fa-lock"></i>
        <h2>Connexion requise</h2>
        <p>Vous devez √™tre connect√© pour voir les captures.</p>
        <a routerLink="/login" class="button primary">Se connecter</a>
      </div>
    } @else {
      <!-- Sous-onglets pour le mode de vue -->
      <div class="tabs-section">
        <button 
          class="tab-btn" 
          [class.active]="viewMode() === 'my'"
          (click)="setViewMode('my')"
          [disabled]="dataMode() === 'raw'"
        >
          <i class="fa fa-user"></i> Mes captures
        </button>
        <button 
          class="tab-btn" 
          [class.active]="viewMode() === 'all'"
          (click)="setViewMode('all')"
        >
          <i class="fa fa-globe"></i> Toutes
        </button>
        <button 
          class="tab-btn" 
          [class.active]="viewMode() === 'recent'"
          (click)="setViewMode('recent')"
        >
          <i class="fa fa-clock-o"></i> R√©centes
        </button>
      </div>

      @if (loading()) {
        <div class="loading">
          <i class="fa fa-spinner fa-spin"></i> Chargement...
        </div>
      } @else if (error()) {
        <div class="error-message">
          <i class="fa fa-exclamation-triangle"></i> {{ error() }}
        </div>
      } @else {
        @if (allCaptures().length === 0) {
          <div class="empty-state">
            <div class="empty-icon">üì¶</div>
            <h2>Aucune capture</h2>
            <p>Aucun Pok√©mon n'a encore √©t√© captur√©.</p>
            <a routerLink="/pokedex" class="button">
              <i class="fa fa-book"></i> Explorer le Pok√©dex
            </a>
          </div>
        } @else if (capturesForCurrentView().length === 0) {
          <div class="empty-state">
            <div class="empty-icon">üéØ</div>
            <h2>Aucune capture</h2>
            <p>{{ viewMode() === 'my' ? 'Vous n\'avez pas encore captur√© de Pok√©mon.' : 'Aucune capture dans cette cat√©gorie.' }}</p>
            <a routerLink="/pokedex" class="button">
              <i class="fa fa-book"></i> Explorer le Pok√©dex
            </a>
          </div>
        } @else {
          <div class="list-container">
            <div class="search-header">
              <div class="search-input-wrapper">
                <i class="fa fa-search"></i>
                <input 
                  type="search" 
                  class="search-input" 
                  placeholder="Rechercher par nom..."
                  [(ngModel)]="searchQuery"
                  [disabled]="dataMode() === 'raw'"
                >
              </div>
              <div class="result-count">
                {{ filteredCaptures().length }} / {{ capturesForCurrentView().length }} captures
              </div>
            </div>
            
            <div class="list-header">
              <span class="col" style="width:50px"></span>
              <span class="col" style="width:60px">#</span>
              <span class="col" style="flex:1">Pok√©mon</span>
              <span class="col" style="width:150px">Dresseur</span>
              <span class="col" style="width:160px">Date</span>
              @if (viewMode() === 'my' && dataMode() !== 'raw') {
                <span class="col" style="width:50px"></span>
              }
            </div>
            
            @for (capture of sortedCaptures(); track capture.id || capture.captureDate) {
              <div class="capture-row" [class.raw-data]="capture.isRawData">
                <span class="col" style="width:50px;text-align:center">
                  <img 
                    [src]="getPokeApiSprite(capture.pokedexNumber)" 
                    [alt]="capture.pokemonName"
                    class="pokemon-icon"
                    loading="lazy"
                    (error)="onIconError($event)"
                  >
                </span>
                <span class="col pokedex-number" style="width:60px">
                  @if (capture.pokedexNumber) {
                    #{{ capture.pokedexNumber.toString().padStart(3, '0') }}
                  } @else {
                    <span class="unknown">‚Äî</span>
                  }
                </span>
                <span class="col pokemon-name" style="flex:1">
                  @if (capture.pokemonId && !capture.isRawData) {
                    <a [routerLink]="['/pokedex', capture.pokemonId]">{{ capture.pokemonName }}</a>
                  } @else {
                    <span class="unknown-name">{{ capture.pokemonName }}</span>
                  }
                </span>
                <span class="col trainer-name" style="width:150px">
                  <i class="fa fa-user"></i> {{ capture.trainerName }}
                </span>
                <span class="col capture-date" style="width:160px">
                  <i class="fa fa-calendar"></i> {{ formatDate(capture.captureDate) }}
                </span>
                @if (viewMode() === 'my' && dataMode() !== 'raw') {
                  <span class="col actions" style="width:50px;text-align:center">
                    <button 
                      class="release-btn" 
                      title="Rel√¢cher ce Pok√©mon"
                      (click)="releasePokemon(capture.id)"
                    >
                      <i class="fa fa-times"></i>
                    </button>
                  </span>
                }
              </div>
            }
            
            @if (filteredCaptures().length === 0 && searchQuery) {
              <div class="no-results">
                <i class="fa fa-search"></i>
                Aucune capture ne correspond √† "{{ searchQuery }}"
              </div>
            }
          </div>
          
          @if (dataMode() === 'raw') {
            <div class="warning-message">
              <i class="fa fa-exclamation-triangle"></i>
              <strong>Donn√©es limit√©es:</strong> Le backend ne retourne pas les informations des Pok√©mon 
              (pokemonId, trainerId). Seuls l'ID de capture et la date sont disponibles.
              <br><br>
              <strong>Solution:</strong> Le backend doit √™tre corrig√© pour retourner <code>pokemonId</code> 
              et <code>trainerId</code> dans les r√©ponses de <code>/api/caught-pokemons</code>.
              <br>
              Voir le fichier <code>.settings/PROBLEM.md</code> pour plus de d√©tails.
            </div>
          }
        }
      }
    }
  </div>
</div>
